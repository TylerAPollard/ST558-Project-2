---
title: "ST558 - Project 2"
author: "Tyler Pollard & Lucy Yin"
output: 
 html_document:
   toc: true
   toc_depth: 3
params: 
      weekday: saturday
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE)
```
# Required Packages
```{r packages, echo=FALSE}
library(tidyverse)
library(dplyr)
library(knitr)
library(ggplot2)
library(caret)
library(gridExtra)
library(corrplot)
library(GGally)
```

# Introduction (lucy)
  
# Data (both)
```{r data - read in}
# read in data
hour.data <- read_csv("data/hour.csv") %>% as_tibble()
day.data <- read_csv("data/day.csv") %>% as_tibble()
```

```{r data - change type}
# correct the variaable types
hour.data$season <- factor(hour.data$season)
levels(hour.data$season) <- list(winter = 1, spring = 2, summer = 3, fall = 4)
hour.data$yr <- factor(hour.data$yr)
levels(hour.data$yr) <- list("2011" = 0, "2012" = 1)
hour.data$mnth <- factor(hour.data$mnth)
hour.data$hr <- factor(hour.data$hr)
hour.data$holiday <- factor(hour.data$holiday)
hour.data$weekday <- factor(hour.data$weekday)
levels(hour.data$weekday) <- list(monday = 1, tuesday = 2, wednesday = 3, thursday = 4, friday = 5, saturday = 6, sunday = 0)
hour.data$workingday <- factor(hour.data$workingday)
hour.data$weathersit <- factor(hour.data$weathersit)

day.data$season <- factor(day.data$season)
levels(day.data$season) <- list(winter = 1, spring = 2, summer = 3, fall = 4)
day.data$yr <- factor(day.data$yr)
levels(day.data$yr) <- list("2011" = 0, "2012" = 1)
day.data$mnth <- factor(day.data$mnth)
day.data$holiday <- factor(day.data$holiday)
day.data$weekday <- factor(day.data$weekday)
levels(day.data$weekday) <- list(monday = 1, tuesday = 2, wednesday = 3, thursday = 4, friday = 5, saturday = 6, sunday = 0)
day.data$workingday <- factor(day.data$workingday)
day.data$weathersit <- factor(day.data$weathersit)
```

```{r data - create total data}
# add in a new variable before merging
hour.data <- mutate(hour.data, type = "hour")
day.data <- mutate(day.data, type = "day", hr = NA) %>% select(instant, dteday, season, yr, mnth, hr, everything())

# merge to create complete list of hour/day data
total.data <- rbind(hour.data, day.data)
```

```{r data - filter parameter}
# filter out to one specific day of the week
hour.data <- hour.data %>% filter(weekday == params$weekday)
day.data <- day.data %>% filter(weekday == params$weekday)
total.data <- total.data %>% filter(weekday == params$weekday)
```

```{r data - split training/test}
# splitting data into training & test sets
set.seed(7)
train <- sample(1:nrow(day.data), size = nrow(day.data)*0.7)
test <- dplyr::setdiff(1:nrow(day.data), train)
day.training.data <- day.data[train, ]
day.test.data <- day.data[test, ]

hour.training.data <- hour.data[hour.data$dteday %in% day.training.data$dteday,]
hour.test.data <- hour.data[hour.data$dteday %in% day.test.data$dteday,]
```

# Summarization (both)
## Contingency Tables
### Weather Situation
Below is a contigency table that shows the count of days that fall into the different categories of weather situation. This table will 

```{r contigency table - weathersit}
levels(day.training.data$weathersit) <- list(
  "Clear, Few clouds, Partly cloudy, Partly cloudy" = "1",
  "Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist" = "2",
  "Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds" = "3",
  "Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog" = "4")
kable(t(table(day.training.data$weathersit)))
```

### Year, Season and Count of Riders
```{r}

#table(day.training.data$season)
#table(day.training.data$yr)

kable(table(day.training.data$season, cut(day.training.data$cnt, breaks = 2)), caption = "Occurrences of # Range of Riders of a given Season")
kable(table(day.training.data$yr, cut(day.training.data$cnt, breaks = 2)), caption = "Occurrences of # Range of Riders of a given Year")
```

### Working Day and Count of Casual Riders
```{r}
levels(day.training.data$workingday) <- list("workday" = 1, "non-workday" = 0)
kable(table(day.training.data$workingday, cut(day.training.data$casual, breaks = 2)), caption = "Occurrences of # Range of Casual Riders of Workday vs. non-Workday")
```

## Summary Tables
### Adjusted Temperature
```{r summary table - atemp}
tmin = -16
tmax = 50
day.training.data$atemp.unnormal <- day.training.data$atemp*(tmax - tmin) + tmin # Unnormalize temps
day.training.data$atemp.F <- day.training.data$atemp.unnormal*(9/5) + 32 # Convert to farenheit
atemp.summary <- day.training.data %>% group_by(yr) %>% summarise(mean = mean(atemp.F), sd = sd(atemp.F), min = min(atemp.F), Q1 = quantile(atemp.F,0.25), median = median(atemp.F), Q3 = quantile(atemp.F, 0.75), max = max(atemp.F))
kable(atemp.summary, digits = 2)
```

### Humidity
```{r}
kable(t(c(summary(day.training.data$hum), St.Dev. = sd(day.training.data$hum))), digits = 2, caption = "Normalized Humidity")
kable(t(c(summary(day.training.data$hum*100), St.Dev. = sd(day.training.data$hum*100))), digits = 2, caption = "Raw Humidity")  
```

### Wind Speed
```{r}
kable(t(c(summary(day.training.data$windspeed), St.Dev. = sd(day.training.data$windspeed))), digits = 2, caption = "Normalized Wind Speed")
kable(t(c(summary(day.training.data$windspeed*67), St.Dev. = sd(day.training.data$windspeed*67))), digits = 2, caption = "Raw Wind Speed ")
```

## Histograms
### Humidity and Windspeed Distributions
```{r histogram - count}
hum.histogram <- ggplot(data = day.training.data, aes(x = hum)) + 
  geom_histogram(aes(y = ..density..), bins = 30) + 
  geom_density(color = "red", size = 2) + 
  labs(title = "Humidity Distribution", x = "Humidity", y = "Density")
windspeed.histogram <- ggplot(data = day.training.data, aes(x = windspeed)) + 
  geom_histogram(aes(y = ..density..), bins = 30) + 
  geom_density(color = "red", size = 2) + 
  labs(title = "Windspeed Distribution", x = "Windspeed", y = "Density")
grid.arrange(hum.histogram, windspeed.histogram, ncol = 2)
```

## Density Plot
### Casual Riders and Weather Situation
```{r}
ggplot(hour.training.data, aes(x = casual)) + 
  geom_density(alpha = 0.5, aes(fill = weathersit)) + 
  labs(title = "Density plot of casual riders",
       subtitle = "Specified by weather situation",
       x = "Count of Casual Riders",
       y = "Density") + 
  scale_fill_discrete(name = "Weather Situation", labels = c("Mostly Clear", "Mist", "Light Precip.", "Heavy Precip."))  
```

### Casual Riders and Holiday
```{r}
ggplot(hour.training.data, aes(x = casual)) + 
  geom_density(alpha = 0.5, aes(fill = holiday)) +
  labs(title = "Density plot of casual riders",
       subtitle = "Specified by holiday or not",
       x = "Count of Casual Riders",
       y = "Density") +
  scale_fill_discrete(name = "Holiday?", labels = c("Non-Holiday", "Holiday"))    
```

## Boxplots
### Adjusted Temperature Over the Year
```{r boxplot- adjusted temperature}
atemp.boxplot.df <- day.training.data
levels(atemp.boxplot.df$mnth) <- list(January = 1, February = 2, March = 3, April = 4, May = 5, June = 6, July = 7, August = 8, September = 9, October = 10, November = 11, December = 12)
ggplot(data = atemp.boxplot.df, aes(x = mnth, y = atemp.F)) + 
  geom_boxplot() + 
  geom_point(position = "jitter", color = "blue") + 
  labs(title = "Adjusted temperature distribution per month", x = "Month", y = "Adjusted Temperature (F)")
```

### Riders of Every Hour and Weather Situation
```{r}
ggplot(hour.training.data, aes(x = hr, y = cnt)) + 
  geom_boxplot() + 
  stat_summary(fun = mean, geom = "line", lwd = 0.8, aes(group = weathersit, col = weathersit)) + 
  labs(title = "Count of riders for every hr",
       subtitle = "Mean values based on weather situation",
       x = "Hour of the Day",
       y = "Count of Riders") + 
  scale_color_discrete(name = "Weather Situation", labels = c("Mostly Clear", "Mist", "Light Precip.", "Heavy Precip."))
```

## Scatter Plots
### Adjusted Temperature Drivers
```{r scatter - atemp vs temp}
ggplot(data = day.training.data, aes(x = temp, y = atemp)) + geom_point() + geom_smooth(method = "lm") + 
  labs(title = "Adjusted Temperature vs Temperature", x = "Temperature", y = "Adjusted Temperature")
```

### Count vs Casual by Season
```{r scatter - registered vs count}
ggplot(data = day.training.data, aes(x = cnt, y = casual)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(cols = vars(season)) + 
  labs(title = "Casual Riders Influence on Total Count", x = "Count", y = "Casual Riders")
```

### Riders vs Temperature
```{r scatter - riders}
# casual.scatter <- ggplot(data = day.training.data, aes(x = temp)) + 
#   geom_point(aes(y = casual, color = "red"))
# registered.scatter <- ggplot(data = day.training.data, aes(x = temp)) + 
#   geom_point(aes(y = registered, color = "blue"))
# grid.arrange(casual.scatter, registered.scatter, ncol =2)
day.training.data$temp.indicator <- ifelse(day.training.data$temp < mean(day.training.data$temp), 0, 1)
day.training.data$temp.indicator <- as_factor(day.training.data$temp.indicator)
levels(day.training.data$temp.indicator) <- list("Low Temperature" = 0, "High Temperature" = 1)
ggplot(data = day.training.data, aes(x = temp, y = casual, color = workingday)) + 
  geom_point() + 
  geom_smooth() + #method = "lm"
  #facet_grid(cols = vars(temp.indicator)) + 
  labs(title = "Casual Riders Based on Temperature", x = "Temperature", y = "Number of Casual Riders")
```

### Riders vs. Hour vs. Month vs. Working Day
```{r}
count.df <- hour.training.data
levels(count.df$mnth) <- list(January = 1, February = 2, March = 3, April = 4, May = 5, June = 6, July = 7, August = 8, September = 9, October = 10, November = 11, December = 12)
ggplot(count.df, aes(x = hr, y = cnt)) +
  geom_point(aes(col = workingday)) +
  facet_wrap(vars(mnth)) + 
  labs(title = "Count of riders for every hour of every month",
       subtitle = "Specified by workday or non-workday",
       x = "Hour of the Day",
       y = "Count of Riders") +
  scale_color_discrete(name = "Working Day")
```

## Correlation Plot 
### Correlation between temp, atemp, hum, windspeed
```{r}
cor.variables <- hour.training.data %>% select(temp, atemp, hum, windspeed)
correlation <- cor(cor.variables, method = "spearman")
corrplot(correlation)
```

## Plots with GGally
### Using Day Data
```{r}
subset.data.day <- data_frame(weathersit=day.training.data$weathersit, temp=day.training.data$temp, atemp=day.training.data$atemp,humidity=day.training.data$hum, windspeed=day.training.data$windspeed, casual=day.training.data$casual, registered=day.training.data$registered, total=day.training.data$cnt)
GGally::ggpairs(subset.data.day)
```

### Using Hour Data
```{r}
subset.data.hr <- data_frame(weathersit=hour.training.data$weathersit, temp=hour.training.data$temp, atemp=hour.training.data$atemp,humidity=hour.training.data$hum, windspeed=hour.training.data$windspeed, casual=hour.training.data$casual, registered=hour.training.data$registered, total=hour.training.data$cnt)
GGally::ggpairs(subset.data.hr)
```


# Modeling
## Linear Regression Model
### What is Linear Regression Model (tyler)

### Picking predictors using AIC
```{r}
# keep only variables that are relevant to modeling
if.weekday <- hour.training.data %>% filter(weekday == params$weekday) %>% select(workingday) %>% unique() %>% nrow()
if.holiday <- hour.training.data %>% filter(weekday == params$weekday) %>% select(holiday) %>% unique() %>% nrow()

get.data <- function(weekday, ...){
  if (if.weekday == 1 & if.holiday == 1) {
    hour.training.data2 <- hour.training.data %>% select(season, yr, mnth, hr, weathersit, temp, atemp, hum, windspeed, cnt)
  }
  else {
    hour.training.data2 <- hour.training.data %>% select(season, yr, mnth, hr, holiday, workingday, weathersit, temp, atemp, hum, windspeed, cnt)
  }
  hour.training.data2
}
hour.training.data2 <- get.data(params$weekday)

# aic using only 1st ordered terms
fit.aic <- step((lm(cnt ~ ., data = hour.training.data2)), direction = "both")

# aic including squared terms and interactions
fit.aic2 <- step((lm(cnt ~ .^2 + I(temp^2) + I(atemp^2) + I(hum^2) + I(windspeed^2), data = hour.training.data2)), direction = "both")
```  

### Linear Regression Model (tyler)

### Linear Regression Model (lucy)
#### Modeling using AIC picked predictors
```{r}
# use all predictors except atemp and holiday
set.seed(7)
fit.mlr0 <- train(cnt ~ season + yr + mnth + hr + workingday + weathersit + temp + hum + windspeed,
                  data = hour.training.data2,
                  method = "lm",
                  trControl = trainControl(method = "cv", number = 10))
fit.mlr0

predict.mlr0 <- postResample(predict(fit.mlr0, newdata = hour.test.data), obs = hour.test.data$cnt)

# use aic predictors (1st ordered terms)
set.seed(7)
fit.mlr1 <- train(fit.aic$terms,
                  data = hour.training.data2,
                  method = "lm",
                  trControl = trainControl(method = "cv", number = 10))
fit.mlr1
predict.mlr1 <- postResample(predict(fit.mlr1, newdata = hour.test.data), obs = hour.test.data$cnt)

# use aic predictors (2nd ordered terms and interactions)
set.seed(7)
fit.mlr2 <- train(fit.aic2$terms,
                  data = hour.training.data2,
                  method = "lm",
                  trControl = trainControl(method = "cv", number = 10))
fit.mlr2
predict.mlr2 <- postResample(predict(fit.mlr2, newdata = hour.test.data), obs = hour.test.data$cnt)
```


## Ensemble Tree Model
### Random Forest Model (tyler)

### Boosted Tree Model (lucy)
The boosted tree model is a type of tree based method where we grow our trees in a sequential manner, each tree we create will be based off the previous tree so we can update our prediction as we go. For example, we'd fit our model and get a prediction, then create a new model based off the previous, update the prediction on this new model, and we'd repeat this process until we decide to stop. Boosted tree model slowly trains the trees to ensure we don't overfit to our training data. How this is actually done is we create new residuals based off `observed - new predictions`, fit a tree to those residuals to get new predictions $\hat{y}$, then update our predictions again by a scaled down version of the new predictions $\lambda \hat{y}^{b}$ (here $\lambda$ is the growth rate tuning parameter, which keeps us from growing our predictions too quickly). We repeat this process a total of `B` times. We can use cross validation to select what $\lambda$, `d` and `B` should be. Formula used to update predictions is $\hat{y} = \hat{y} + \lambda \hat{y}^{b}$.
 
```{r}
set.seed(7)
fit.boosted.trial <- train(fit.aic$terms,
                     data = hour.training.data2,
                     method = "gbm",
                     trControl = trainControl(method = "cv", number = 10),
                     verbose = FALSE)
fit.boosted.trial
```
```{r}
set.seed(7)
fit.boosted <- train(fit.aic$terms,
                     data = hour.training.data2,
                     method = "gbm",
                     trControl = trainControl(method = "cv", number = 10),
                     verbose = FALSE,
                     tuneGrid = expand.grid(interaction.depth = c(3:10),
                                            n.trees = (3:10)*50,
                                            shrinkage = 0.1,
                                            n.minobsinnode = 10))
fit.boosted

predict.boosted <- postResample(predict(fit.boosted, newdata = hour.test.data), obs = hour.test.data$cnt)
```  
  
# Comparison (either)
```{r}
compare.rmse <- data.frame(predict.mlr0, 
                           predict.mlr1,
                           predict.mlr2,
                           predict.boosted)
colnames(compare.rmse) <- c("predict.mlr0", "predict.mlr1", "predict.mlr2", "predict.boosted")
compare.rmse
```
```{r}
apply(compare.rmse["RMSE",], 1, FUN=min)
```

